<html>
<head>

    <title>FireWatch</title>

    <link rel="icon" type="image/x-icon" href="icon.ico">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; width: 100%; }
        #map { height: 100%; }
        /* Expandable details section of map popups*/
        details {
            display: inline-block;
            max-height: 200px;
            overflow-y: scroll;
        }
        details[open] summary::after {  /* When open */
            content: "Hide details";
        }
        summary::after {                /* When closed */
            content: "Show details";
        }
    </style>
   
</head>
<body>

<div id="map">
    <script>

        // set the beginning location for the map
        var map = L.map('map').setView([38, -98], 4);   // [latitude, longitude], zoomFactor

        // add OpenStreetMap layer
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // Function to fetch and display NWS alerts
        async function fetchAndDisplayAlerts(eventType, color) {
            try {
                // Fetch alerts of the given eventType where status=actual (to exclude test alerts)
                const response = await fetch(`https://api.weather.gov/alerts/active?event=${encodeURIComponent(eventType)}&status=actual`);
                const data = await response.json();
    
                for (let alert of data.features) {
                    // Case 1: Alert contains direct geometry (polygon)
                    if (alert.geometry && alert.geometry.type === "Polygon") {
                        
                        // Create an array of [latitude,longitude] pairs that represent the alert perimeter
                        let coords = alert.geometry.coordinates[0].map(coord => [coord[1], coord[0]]);
                        
                        // Add the polygon to the map
                        L.polygon(coords, { color: color, fillOpacity: 0.4 }).addTo(map)
                            .bindPopup(`<b>${alert.properties.event}</b>
                                        <br>${alert.properties.headline}
                                        <br><details><summary></summary>
                                        ${alert.properties.description}
                                        </details>`);
                    } 
                    // Case 2: Alert provides affectedZones (UGC geocode) instead of geometry
                    else if (alert.properties.affectedZones) {
                        for (let zoneURL of alert.properties.affectedZones) {
                            try {
                                // Fetch the coordinates of the given affectedZone
                                let zoneResponse = await fetch(zoneURL);
                                let zoneData = await zoneResponse.json();
    
                                if (zoneData.geometry && zoneData.geometry.type === "Polygon") {
                                    
                                    // Create an array of [latitude,longitude] pairs that represent the zone perimeter
                                    let zoneCoords = zoneData.geometry.coordinates[0].map(coord => [coord[1], coord[0]]);
                                    
                                    // Add the polygon to the map
                                    L.polygon(zoneCoords, { color: color, fillOpacity: 0.4 }).addTo(map)
                                        .bindPopup(`<b>${alert.properties.event}</b>
                                        <br>${alert.properties.headline}
                                        <br><details><summary></summary>
                                        ${alert.properties.description}
                                        </details>`);
                                }
                            } catch (error) {
                                console.error("Error fetching zone data:", error);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error(`Error fetching ${eventType} alerts:`, error);
            }
        }

        // Function to fetch and display active fires from FireNRT API
        async function fetchAndDisplayFires(color,offset) {
            try {
                const response = await fetch(`https://firenrt.delta-backend.com/collections/public.eis_fire_lf_perimeter_nrt/items?
                                                region=CONUS&limit=9999&offset=${encodeURIComponent(offset)}&f=geojson`);
                const fireData = await response.json();

                // Used to check if there are more items than the query limit
                let numMatched = fireData.numberMatched;

                for (let firePerimeter of fireData.features) {
                    if (firePerimeter.geometry) {
                        
                        // Create an array of [latitude,longitude] pairs that represent the fire perimeter
                        let coords = firePerimeter.geometry.coordinates[0].map(coord => [coord[1], coord[0]]);
                        
                        // Add the polygon to the map
                        L.polygon(coords, { color: color, fillOpacity: 0.4 }).addTo(map)
                            .bindPopup(`<b>${firePerimeter.id}</b>
                                        <br>Fire area: ${firePerimeter.properties.farea} Km^2
                                        <br><details><summary></summary>
                                        </details>`);            
                    }
                    else {
                        console.error(`Error fetching ${firePerimeter}`);
                    }
                }

                return numMatched;

            } catch (error) {
                console.error("Error fetching fire data:", error);
            }
        }

        // Make initial query to fetch fire data and return total number of items
        let numMatched = fetchAndDisplayFires("red", 0);

        // If there are more items than what the query limit allows, make additional calls
        if (numMatched > 9999) {
            for (let offset = 0; offset < numMatched; offset = offset + 9999) {
                fetchAndDisplayFires("red", offset);
            }
        }
        
        // Fetch alerts for both wildfire event types
        fetchAndDisplayAlerts("Fire Warning", "red");
        fetchAndDisplayAlerts("Red Flag Warning", "orange");
        fetchAndDisplayAlerts("Fire Weather Watch", "yellow");
    </script>
</div>

</body>
</html>
